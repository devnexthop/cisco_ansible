---
- name: Generate Switch Inventory Report
  hosts: switches
  gather_facts: no

  tasks:
    - name: Disable paging
      cisco.ios.ios_command:
        commands:
          - terminal length 0
      register: paging_result
      ignore_errors: yes
      vars:
        ansible_command_timeout: 10

    - name: Get switch version information
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Get switch inventory information
      cisco.ios.ios_command:
        commands:
          - show inventory
      register: inventory_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Extract software version from show version
      ansible.builtin.set_fact:
        software_version: "{{ ((version_result.stdout[0] | regex_search('Version (\\S+)')) | default([]) | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract model number (PID) from show inventory - Method 1 (NAME line)
      ansible.builtin.set_fact:
        model_pid: "{{ ((inventory_result.stdout[0] | regex_search('NAME:\\s*\"([^\"]+)\"')) | default([]) | first) | default('') }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Extract model number (PID) from show inventory - Method 2 (PID line)
      ansible.builtin.set_fact:
        model_pid: "{{ ((inventory_result.stdout[0] | regex_search('PID:\\s+(\\S+)')) | default([]) | first) | default(model_pid | default('Unknown')) }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0
        - (model_pid | default('')) == ""

    - name: Extract model number (PID) from show version - Method 3 (fallback)
      ansible.builtin.set_fact:
        model_pid: "{{ ((version_result.stdout[0] | regex_search('Model Number\\s+:\\s+(\\S+)')) | default([]) | first) | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == "" or model_pid == "Unknown"

    - name: Extract serial number from show inventory
      ansible.builtin.set_fact:
        serial_number: "{{ ((inventory_result.stdout[0] | regex_search('SN:\\s+(\\S+)')) | default([]) | first) | default('Unknown') }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Extract serial number from show version (fallback)
      ansible.builtin.set_fact:
        serial_number: "{{ ((version_result.stdout[0] | regex_search('System Serial Number\\s+:\\s+(\\S+)')) | default([]) | first) | default(serial_number | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (serial_number | default('')) == "" or serial_number == "Unknown"

    - name: Extract hostname from show version
      ansible.builtin.set_fact:
        device_hostname: "{{ ((version_result.stdout[0] | regex_search('^([^\\s#]+)')) | default([]) | first) | default(inventory_hostname) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract IOS version details
      ansible.builtin.set_fact:
        ios_version: "{{ ((version_result.stdout[0] | regex_search('IOS.*Version (\\S+)')) | default([]) | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract ROM version
      ansible.builtin.set_fact:
        rom_version: "Unknown"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract ROM version (if present)
      ansible.builtin.set_fact:
        rom_version: "{{ (version_result.stdout[0] | regex_search('ROM:.*Version (\\S+)') | list | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - "'ROM:' in version_result.stdout[0]"

    - name: Display switch inventory information
      ansible.builtin.debug:
        msg: |
          ========================================
          SWITCH INVENTORY INFORMATION
          ========================================
          Hostname: {{ device_hostname | default(inventory_hostname) }}
          IP Address: {{ ansible_host }}
          Model (PID): {{ model_pid | default('Unknown') }}
          Software Version: {{ software_version | default('Unknown') }}
          IOS Version: {{ ios_version | default(software_version | default('Unknown')) }}
          ROM Version: {{ rom_version | default('Unknown') }}
          Serial Number: {{ serial_number | default('Unknown') }}
          ========================================
