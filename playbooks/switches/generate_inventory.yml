---
- name: Generate Switch Inventory Report
  hosts: switches
  gather_facts: no

  tasks:
    - name: Disable paging
      cisco.ios.ios_command:
        commands:
          - terminal length 0
      register: paging_result

    - name: Get switch version information
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Extract software version
      ansible.builtin.set_fact:
        software_version: "{{ (version_result.stdout[0] | regex_search('Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract model number (PID) - Method 1
      ansible.builtin.set_fact:
        model_pid: "{{ (version_result.stdout[0] | regex_search('Model Number\\s+:\\s+(\\S+)') | first) | default('') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract model number (PID) - Method 2 (from processor line)
      ansible.builtin.set_fact:
        model_pid: "{{ (version_result.stdout[0] | regex_search('(WS-\\S+|CISCO\\d+\\S+)') | first) | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == ""

    - name: Extract model number (PID) - Method 3 (from system image)
      ansible.builtin.set_fact:
        model_pid: "{{ (version_result.stdout[0] | regex_search('System image file is.*/([^/]+)/') | first) | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == "" or model_pid == "Unknown"

    - name: Extract serial number
      ansible.builtin.set_fact:
        serial_number: "{{ (version_result.stdout[0] | regex_search('System Serial Number\\s+:\\s+(\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract hostname
      ansible.builtin.set_fact:
        device_hostname: "{{ (version_result.stdout[0] | regex_search('^([^\\s]+)\\s+uptime') | first) | default(inventory_hostname) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract IOS version details
      ansible.builtin.set_fact:
        ios_version: "{{ (version_result.stdout[0] | regex_search('IOS.*Version (\\S+)') | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract ROM version
      ansible.builtin.set_fact:
        rom_version: "{{ (version_result.stdout[0] | regex_search('ROM:.*Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Display switch inventory information
      ansible.builtin.debug:
        msg: |
          ========================================
          SWITCH INVENTORY INFORMATION
          ========================================
          Hostname: {{ device_hostname | default(inventory_hostname) }}
          IP Address: {{ ansible_host }}
          Model (PID): {{ model_pid | default('Unknown') }}
          Software Version: {{ software_version | default('Unknown') }}
          IOS Version: {{ ios_version | default(software_version | default('Unknown')) }}
          ROM Version: {{ rom_version | default('Unknown') }}
          Serial Number: {{ serial_number | default('Unknown') }}
          ========================================
