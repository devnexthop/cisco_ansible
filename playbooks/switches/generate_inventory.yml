---
- name: Generate Switch Inventory Report
  hosts: switches
  gather_facts: no

  tasks:
    - name: Disable paging
      cisco.ios.ios_command:
        commands:
          - terminal length 0
      register: paging_result
      ignore_errors: yes
      vars:
        ansible_command_timeout: 10

    - name: Get switch version information
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Get switch inventory information
      cisco.ios.ios_command:
        commands:
          - show inventory
      register: inventory_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Extract software version from show version (IOS XE format)
      ansible.builtin.set_fact:
        software_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS XE Software, Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract software version from show version (IOS format fallback)
      ansible.builtin.set_fact:
        software_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS Software.*Version (\\S+)') | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (software_version | default('')) == "" or software_version == "Unknown"

    - name: Extract hostname from show version
      ansible.builtin.set_fact:
        device_hostname: "{{ (version_result.stdout[0] | regex_findall('^([A-Z0-9_]+)\\s+uptime') | first) | default(inventory_hostname) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract IOS version details
      ansible.builtin.set_fact:
        ios_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS Software.*Version (\\S+)') | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract ROM version
      ansible.builtin.set_fact:
        rom_version: "{{ (version_result.stdout[0] | regex_findall('BOOTLDR:.*Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
      failed_when: false

    - name: Extract switch table section from show version
      ansible.builtin.set_fact:
        switch_table_section: "{{ version_result.stdout[0].split('Switch Ports Model')[1].split('Switch 0')[0] if 'Switch Ports Model' in version_result.stdout[0] else '' }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Parse switch table lines
      ansible.builtin.set_fact:
        switch_table_lines: "{{ switch_table_section.split('\\n') | select('match', '^[\\*\\s]+\\d+\\s+\\d+') | list }}"
      when: 
        - switch_table_section is defined
        - switch_table_section != ""

    - name: Extract switches from table
      ansible.builtin.set_fact:
        switches_from_table: "{{ switches_from_table | default([]) + [{'switch_num': (item | regex_findall('^[\\*\\s]+(\\d+)') | first | default('')), 'model': (item | regex_findall('(C\\d+-\\S+)') | first | default('')), 'sw_version': (item | regex_findall('(\\d+\\.\\d+\\.\\d+)') | first | default(''))}] }}"
      loop: "{{ switch_table_lines | default([]) }}"
      when: 
        - switch_table_lines is defined
        - switch_table_lines | length > 0

    - name: Split inventory by Switch entries
      ansible.builtin.set_fact:
        inventory_switch_sections: "{{ inventory_result.stdout[0].split('NAME: \"Switch ') | select('match', '^\\d+') | list }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Extract all switches from inventory
      ansible.builtin.set_fact:
        switches_from_inventory: "{{ switches_from_inventory | default([]) + [{'switch_num': (item | regex_findall('^(\\d+)') | first | default('1')), 'pid': (item | regex_findall('PID: (C\\d+-\\S+)') | first | default('')), 'sn': (item | regex_findall('SN: ([A-Z0-9]+)') | first | default(''))}] }}"
      loop: "{{ inventory_switch_sections | default([]) }}"
      when: 
        - inventory_switch_sections is defined
        - inventory_switch_sections | length > 0

    - name: Combine switch information from both sources
      ansible.builtin.set_fact:
        all_switches: "{{ all_switches | default([]) + [{'switch_num': inv_switch.switch_num, 'pid': inv_switch.pid, 'sn': inv_switch.sn, 'sw_version': (switches_from_table | selectattr('switch_num', 'equalto', inv_switch.switch_num) | map(attribute='sw_version') | first) | default(software_version | default('Unknown'))}] }}"
      loop: "{{ switches_from_inventory | default([]) }}"
      loop_control:
        loop_var: inv_switch
      when: 
        - switches_from_inventory is defined
        - switches_from_inventory | length > 0

    - name: Display switch inventory information - Header
      ansible.builtin.debug:
        msg: |
          ========================================
          SWITCH INVENTORY INFORMATION
          ========================================
          Switch Name: {{ device_hostname | default(inventory_hostname) }}
          IP Address: {{ ansible_host }}
          Software Version: {{ software_version | default('Unknown') }}
          IOS Version: {{ ios_version | default(software_version | default('Unknown')) }}
          ROM Version: {{ rom_version | default('Unknown') }}
          ========================================
          SWITCHES IN STACK:
          ========================================

    - name: Display each switch in stack
      ansible.builtin.debug:
        msg: |
          Switch {{ item.switch_num }}:
            PID: {{ item.pid | default('Unknown') }}
            SN: {{ item.sn | default('Unknown') }}
            SW Version: {{ item.sw_version | default('Unknown') }}
      loop: "{{ all_switches | default([]) }}"
      when: 
        - all_switches is defined
        - all_switches | length > 0

    - name: Display single switch if no stack detected
      ansible.builtin.debug:
        msg: |
          Switch 1:
            PID: {{ (inventory_result.stdout[0] | regex_findall('NAME: \"Switch 1\".*?PID: (C\\d+-\\S+)') | first) | default((inventory_result.stdout[0] | regex_findall('PID: (C\\d+-\\S+)') | first) | default('Unknown')) }}
            SN: {{ (inventory_result.stdout[0] | regex_findall('NAME: \"Switch 1\".*?SN: ([A-Z0-9]+)') | first) | default((inventory_result.stdout[0] | regex_findall('PID: C\\d+-\\S+.*?SN: ([A-Z0-9]+)') | first) | default((version_result.stdout[0] | regex_findall('System Serial Number\\s+:\\s+(\\S+)') | first) | default('Unknown'))) }}
            SW Version: {{ software_version | default('Unknown') }}
      when: 
        - all_switches is not defined or all_switches | length == 0
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Display footer
      ansible.builtin.debug:
        msg: "========================================"
