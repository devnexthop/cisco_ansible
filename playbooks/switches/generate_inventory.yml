---
- name: Generate Switch Inventory Report
  hosts: switches
  gather_facts: no

  tasks:
    - name: Disable paging
      cisco.ios.ios_command:
        commands:
          - terminal length 0
      register: paging_result
      ignore_errors: yes
      vars:
        ansible_command_timeout: 10

    - name: Get switch version information
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Get switch inventory information
      cisco.ios.ios_command:
        commands:
          - show inventory
      register: inventory_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Extract software version from show version (IOS XE format)
      ansible.builtin.set_fact:
        software_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS XE Software, Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract software version from show version (IOS format fallback)
      ansible.builtin.set_fact:
        software_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS Software.*Version (\\S+)') | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (software_version | default('')) == "" or software_version == "Unknown"

    - name: Extract model number (PID) from show inventory - Get Switch 1 PID
      ansible.builtin.set_fact:
        model_pid: "{{ (inventory_result.stdout[0] | regex_findall('NAME: \"Switch 1\".*?PID: (C\\d+-\\S+)') | first) | default('') }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Extract model number (PID) from show inventory - Get first C-series PID (fallback)
      ansible.builtin.set_fact:
        model_pid: "{{ (inventory_result.stdout[0] | regex_findall('PID: (C\\d+-\\S+)') | first) | default(model_pid | default('')) }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0
        - (model_pid | default('')) == ""

    - name: Extract model number (PID) from show version - Method 3 (fallback)
      ansible.builtin.set_fact:
        model_pid: "{{ (version_result.stdout[0] | regex_findall('Model Number\\s+:\\s+(\\S+)') | first) | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == "" or model_pid == "Unknown"

    - name: Extract serial number from show inventory - Get Switch 1 SN
      ansible.builtin.set_fact:
        serial_number: "{{ (inventory_result.stdout[0] | regex_findall('NAME: \"Switch 1\".*?SN: ([A-Z0-9]+)') | first) | default('') }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0

    - name: Extract serial number from show inventory - Get first SN after C-series PID (fallback)
      ansible.builtin.set_fact:
        serial_number: "{{ (inventory_result.stdout[0] | regex_findall('PID: C\\d+-\\S+.*?SN: ([A-Z0-9]+)') | first) | default(serial_number | default('')) }}"
      when: 
        - inventory_result.stdout is defined
        - inventory_result.stdout | length > 0
        - (serial_number | default('')) == ""

    - name: Extract serial number from show version (fallback)
      ansible.builtin.set_fact:
        serial_number: "{{ (version_result.stdout[0] | regex_findall('System Serial Number\\s+:\\s+(\\S+)') | first) | default(serial_number | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (serial_number | default('')) == "" or serial_number == "Unknown"

    - name: Extract hostname from show version
      ansible.builtin.set_fact:
        device_hostname: "{{ (version_result.stdout[0] | regex_findall('^([A-Z0-9_]+)\\s+uptime') | first) | default(inventory_hostname) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract IOS version details
      ansible.builtin.set_fact:
        ios_version: "{{ (version_result.stdout[0] | regex_findall('Cisco IOS Software.*Version (\\S+)') | first) | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract ROM version
      ansible.builtin.set_fact:
        rom_version: "{{ (version_result.stdout[0] | regex_findall('BOOTLDR:.*Version (\\S+)') | first) | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
      failed_when: false

    - name: Display switch inventory information
      ansible.builtin.debug:
        msg: |
          ========================================
          SWITCH INVENTORY INFORMATION
          ========================================
          Switch Name: {{ device_hostname | default(inventory_hostname) }}
          PID: {{ model_pid | default('Unknown') }}
          SN: {{ serial_number | default('Unknown') }}
          Software Version: {{ software_version | default('Unknown') }}
          IOS Version: {{ ios_version | default(software_version | default('Unknown')) }}
          ROM Version: {{ rom_version | default('Unknown') }}
          IP Address: {{ ansible_host }}
          ========================================
