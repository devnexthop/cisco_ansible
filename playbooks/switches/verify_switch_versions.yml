---
- name: Verify Switch Versions
  hosts: switches
  gather_facts: no

  tasks:
    - name: Get switch version information
      cisco.ios.ios_command:
        commands:
          - terminal length 0
          - show version
      register: version_result
      failed_when: false
      vars:
        ansible_command_timeout: 60

    - name: Extract software version
      ansible.builtin.set_fact:
        software_version: "{{ version_result.stdout[0] | regex_search('Version (\\S+)', 'multiline') | first | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract model number (PID) - Method 1 (Model Number line)
      ansible.builtin.set_fact:
        model_pid: "{{ version_result.stdout[0] | regex_search('Model Number\\s+:\\s+(\\S+)', 'multiline', 'ignorecase') | first | default('') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract model number (PID) - Method 2 (Processor line)
      ansible.builtin.set_fact:
        model_pid: "{{ version_result.stdout[0] | regex_search('(WS-\\S+|CISCO\\d+\\S+)', 'multiline') | first | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == ""

    - name: Extract model number (PID) - Method 3 (System image)
      ansible.builtin.set_fact:
        model_pid: "{{ version_result.stdout[0] | regex_search('System image file is.*/([^/]+)/', 'multiline', 'ignorecase') | first | default(model_pid | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0
        - (model_pid | default('')) == "" or model_pid == "Unknown"

    - name: Extract serial number
      ansible.builtin.set_fact:
        serial_number: "{{ version_result.stdout[0] | regex_search('System Serial Number\\s+:\\s+(\\S+)', 'multiline', 'ignorecase') | first | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract uptime
      ansible.builtin.set_fact:
        uptime: "{{ version_result.stdout[0] | regex_search('uptime is (.+)', 'multiline', 'ignorecase') | first | default('Unknown') }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract hostname
      ansible.builtin.set_fact:
        device_hostname: "{{ version_result.stdout[0] | regex_search('^([^\\s]+)\\s+uptime', 'multiline') | first | default(inventory_hostname) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Extract IOS version details
      ansible.builtin.set_fact:
        ios_version: "{{ version_result.stdout[0] | regex_search('IOS.*Version (\\S+)', 'multiline', 'ignorecase') | first | default(software_version | default('Unknown')) }}"
      when: 
        - version_result.stdout is defined
        - version_result.stdout | length > 0

    - name: Display switch version information
      ansible.builtin.debug:
        msg: |
          ========================================
          SWITCH VERSION INFORMATION
          ========================================
          Hostname: {{ device_hostname | default(inventory_hostname) }}
          IP Address: {{ ansible_host }}
          Model (PID): {{ model_pid | default('Unknown') }}
          Software Version: {{ software_version | default('Unknown') }}
          IOS Version: {{ ios_version | default(software_version | default('Unknown')) }}
          Serial Number: {{ serial_number | default('Unknown') }}
          Uptime: {{ uptime | default('Unknown') }}
          ========================================
