---
- name: Network Topology Discovery
  hosts: switches
  gather_facts: no
  strategy: free

  tasks:
    - name: Get CDP neighbors (brief - faster)
      cisco.ios.ios_command:
        commands:
          - terminal length 0
          - show cdp neighbors
      register: cdp_result
      failed_when: false
      vars:
        ansible_command_timeout: 30

    - name: Get LLDP neighbors (if available - brief)
      cisco.ios.ios_command:
        commands:
          - show lldp neighbors
      register: lldp_result
      failed_when: false
      vars:
        ansible_command_timeout: 30

    - name: Parse CDP neighbors
      ansible.builtin.set_fact:
        cdp_neighbors: "{{ cdp_result.stdout[1].split('\\n') | select('match', '^[A-Z]') | list | map('regex_replace', '^([^\\s]+)\\s+([^\\s]+)\\s+\\d+\\s+([^\\s]+)\\s+([^\\s]+)') | list }}"
      when: 
        - cdp_result.stdout is defined
        - cdp_result.stdout | length > 1

    - name: Extract CDP neighbor details
      ansible.builtin.set_fact:
        cdp_devices: "{{ cdp_devices | default([]) + [{'device_id': item.split()[0] if item.split() | length > 0 else 'unknown', 'local_port': item.split()[1] if item.split() | length > 1 else 'unknown', 'remote_port': item.split()[2] if item.split() | length > 2 else 'unknown', 'capability': item.split()[3] if item.split() | length > 3 else 'unknown'}] }}"
      loop: "{{ cdp_result.stdout[1].split('\\n') | select('match', '^[A-Z]') | list }}"
      when: 
        - cdp_result.stdout is defined
        - cdp_result.stdout | length > 1

    - name: Display network topology
      ansible.builtin.debug:
        msg: |
          ========================================
          NETWORK TOPOLOGY DISCOVERY
          ========================================
          Switch: {{ inventory_hostname }}
          IP Address: {{ ansible_host }}
          CDP Neighbors: {{ cdp_devices | default([]) | length }}
          LLDP Neighbors: {{ lldp_result.stdout[0].split('\\n') | select('match', '^[A-Z]') | list | length if lldp_result.stdout is defined else 0 }}
          ========================================

    - name: Display CDP neighbors
      ansible.builtin.debug:
        msg: "{{ item.device_id }} | Local: {{ item.local_port }} | Remote: {{ item.remote_port }} | Capability: {{ item.capability }}"
      loop: "{{ cdp_devices | default([]) }}"
      when: 
        - cdp_devices is defined
        - cdp_devices | length > 0

    - name: Display no neighbors message
      ansible.builtin.debug:
        msg: "No CDP neighbors found"
      when: 
        - cdp_devices is not defined or cdp_devices | length == 0
